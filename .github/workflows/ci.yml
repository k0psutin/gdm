name: checks
on: 
  pull_request:
    branches:
      - main

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref }}'
  cancel-in-progress: true

jobs:
    checks:
        runs-on: ubuntu-latest
        permissions:
          contents: read
          pull-requests: write
        steps:
        - uses: actions/checkout@v5
        - uses: actions-rust-lang/setup-rust-toolchain@v1
          with:
            components: |
                clippy
                rustfmt
        - name: Install audit
          run: cargo install cargo-audit --locked
        - name: Run audit
          run: cargo audit
        - name: Run clippy
          run: cargo clippy -- -D warnings
        - name: Rustfmt Check
          uses: actions-rust-lang/rustfmt@v1
        - name: Install cargo-llvm-cov
          uses: taiki-e/install-action@cargo-llvm-cov
        - name: Generate code coverage
          run: cargo llvm-cov -q --lcov --output-path lcov.info
        - name: Get previous coverage from Gist
          id: gist_content
          uses: gorgbus/gist-actions@main
          env:
            GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
          with:
            action: "get"
            gist_id: "02a7627bd5ba7bdaaf0063e02cadcfde"
            file_name: "gdm_coverage.json"
        - name: Setup LCOV
          uses: hrishikesh-kadam/setup-lcov@v1
        - name: Report code coverage
          uses: zgosalvez/github-actions-report-lcov@v4
          with:
            coverage-files: lcov.info
            minimum-coverage: ${{ fromJson(steps.gist_content.outputs.content).coverage }}
            github-token: ${{ secrets.GITHUB_TOKEN }}
            update-comment: true
    build-windows:
      name: build (windows-latest)
      needs: checks
      runs-on: windows-latest
      steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Install Windows targets
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: |
            x86_64-pc-windows-gnu
      
      - name: Build the executable
        run: cargo build --release --target x86_64-pc-windows-gnu
    build-linux:
      name: build (ubuntu-latest)
      needs: checks
      runs-on: ubuntu-latest
      steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
      
      - name: Install Linux and Windows Cross Compilers
        run: sudo apt-get update && sudo apt-get install --yes musl-dev musl-tools gcc-mingw-w64-x86-64-win32 libssl-dev

      - name: Install Linux and Windows targets
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: |
            x86_64-unknown-linux-musl
      
      - name: Build the executable
        run: cargo build --release --target x86_64-unknown-linux-musl
    build-macos:
      name: build (macos-latest)
      needs: checks
      runs-on: macos-latest
      steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Install MacOS targets
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: |
            x86_64-apple-darwin
            aarch64-apple-darwin

      - name: Build the executable
        run: cargo build --release --target=x86_64-apple-darwin --target=aarch64-apple-darwin